" Main Vim configuration (sourced by platform-specific entry points)

" => General settings
set nocompatible        " Behave like Vim, not Vi
let mapleader=','       " Set leader key

" set ttyfast " Obsolete in modern Vim
set cursorline          " Highlight current line
set title               " Show file name in window title

" Auto read from file change
set autoread
au FocusGained,BufEnter * checktime

" => UI and display
" Ignore compiled files and common VCS directories
set wildignore+=*.o,*~,*.pyc,*.class,*.swp,*.bak
set wildignore+=*/.git/*,*/.hg/*,*/.svn/*,*/.DS_Store " Unix-like specific, Windows will use its own or override

" Configure backspace behavior
set backspace=indent,eol,start
set whichwrap+=<,>,h,l

" Search settings
" set ignorecase " Keep commented as smartcase is used
set smartcase           " Smart case-sensitive search
set hlsearch            " Highlight search results
set incsearch           " Incremental search

" Performance and responsiveness
set lazyredraw          " Don't redraw while executing macros
set showmatch           " Show matching brackets
set mat=2               " How many tenths of a second to blink when matching brackets
set noerrorbells        " No annoying sound on errors
set novisualbell        " No visual bell
set t_vb=               " Disable visual bell
set tm=500              " Timeout for key codes

" => Colors and Fonts
syntax enable           " Enable syntax highlighting
set background=dark     " Set background to dark
colorscheme peaksea     " Use peaksea colorscheme
set colorcolumn=81      " Highlight column 81

" Enable true colors in modern terminals if supported
if has("termguicolors")
    set termguicolors
endif
" if $COLORTERM == 'gnome-terminal' " Less general
"     set t_Co=256
" endif

" Encoding settings (crucial for cross-platform compatibility)
set encoding=utf-8
set fileencodings=utf-8,gbk,gb18030,latin1 " Robust file encoding detection
set termencoding=utf-8

" Use Unix as the standard file type
set ffs=unix,dos,mac

" => Files, backups and undo
set nobackup            " Turn backup off
set nowb                " Turn write backup off
set noswapfile          " Turn swap file off
set hidden              " Allow switching buffers without saving

" => Text, tab and indent related
set expandtab           " Use spaces instead of tabs
set smarttab            " Be smart when using tabs
set shiftwidth=4        " 1 tab == 4 spaces for autoindent
set tabstop=4           " 1 tab == 4 spaces for display

set autoindent          " Auto indent
set smartindent         " Smart indent
set wrap                " Wrap lines
set lbr                 " Linebreak on word boundaries
set tw=500              " Text width (very large, effectively disables auto-wrapping)

" Add a bit extra margin to the left for foldcolumn
set foldcolumn=1

" Better display for messages
set cmdheight=2
set tags=./.tags;,.tags " Tags file search path

" Terminal settings
set t_ti= t_te=         " Reserve file content on screen (useful for tmux/screen)
set completeopt-=preview " Disable preview window for completion
filetype indent on      " Enable filetype-specific indenting

" Make sure that enter is never overriden in the quickfix window
autocmd BufReadPost quickfix nnoremap <buffer> <CR> <CR>

" Python specific indent settings
autocmd FileType python setlocal et sta sw=4 sts=4

" Custom statusline
set statusline=%1*\%<%.50F\             " File name and path
set statusline+=%=%2*\%y%m%r%h%w\ %*        " File type and status
set statusline+=%3*\%{&ff}\[%{&fenc}]\ %*   " File encoding
set statusline+=%4*\ row:%l/%L,col:%c\ %*   " Cursor line and column
set statusline+=%5*\%3p%%\%*            " Percentage through file
set laststatus=2                        " Always show statusline

" => General abbreviations
iab xdate <C-r>=strftime("%d/%m/%y %H:%M:%S")<cr>

" Custom command to search for a word
command! -nargs=1 SS let @/ = '\V'.escape(<q-args>, '\')

" Autocmd group for quickfix window closing
aug QFClose
  au!
  au WinEnter * if winnr('$') == 1 && &buftype == "quickfix"|q|endif
aug END

" Source additional configuration files from the same directory (.vim/)
" These paths assume the .vim directory is the runtimepath or sourced directly
try
    source <sfile>:p:h/functions.vim
    source <sfile>:p:h/keys.vim
    source <sfile>:p:h/plugin.vim
catch
endtry